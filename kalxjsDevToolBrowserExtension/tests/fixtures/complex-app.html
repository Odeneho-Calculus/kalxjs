<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KALXJS DevTools Test App - Complex</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 20px;
        }

        h1 {
            margin-bottom: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .widget {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        button {
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="app" class="container">
        <h1>KALXJS DevTools Complex Test App</h1>
        <div id="dashboard"></div>
    </div>

    <script>
        // Simulate KALXJS framework
        window.__KALXJS__ = {
            version: '2.2.8',
            ready: true,
            components: new Map(),
            hooks: new Map(),
            state: new Map()
        };

        // Base component class
        class Component {
            constructor(name, id) {
                this.name = name;
                this.id = id;
                this.props = {};
                this.state = {};
                this.parent = null;
                this.children = [];
                window.__KALXJS__.components.set(id, this);
            }

            addChild(child) {
                this.children.push(child);
                child.parent = this;
            }

            updateState(newState) {
                Object.assign(this.state, newState);
                window.dispatchEvent(new CustomEvent('kalxjs:stateChange', {
                    detail: { componentId: this.id, state: this.state }
                }));
            }
        }

        // Create component hierarchy
        const dashboard = new Component('Dashboard', 'dashboard-1');
        dashboard.state = { title: 'Dashboard', widgets: [] };

        const widget1 = new Component('Widget', 'widget-1');
        widget1.props = { title: 'Widget 1', data: 42 };
        widget1.state = { value: 100 };
        dashboard.addChild(widget1);

        const widget2 = new Component('Widget', 'widget-2');
        widget2.props = { title: 'Widget 2', data: 'Active' };
        widget2.state = { value: 200, items: [1, 2, 3] };
        dashboard.addChild(widget2);

        const settings = new Component('Settings', 'settings-1');
        settings.state = { theme: 'light', notifications: true };
        dashboard.addChild(settings);

        const toggle = new Component('ToggleSwitch', 'toggle-1');
        toggle.props = { label: 'Notifications' };
        toggle.state = { enabled: true };
        settings.addChild(toggle);

        // Render UI
        const app = document.getElementById('dashboard');
        app.innerHTML = `
            <div class="widget">
                <h2>${dashboard.state.title}</h2>
                <div id="widgets-container"></div>
            </div>
        `;

        const widgetsContainer = document.getElementById('widgets-container');
        dashboard.children.forEach((widget, index) => {
            const div = document.createElement('div');
            div.className = 'widget';
            div.id = widget.id;
            div.innerHTML = `
                <h3>${widget.name}: ${widget.props.title || ''}</h3>
                <p>Value: ${widget.state.value || widget.props.data}</p>
                <button onclick="window.updateWidget('${widget.id}')">Update</button>
            `;
            widgetsContainer.appendChild(div);
        });

        // Global update function for testing
        window.updateWidget = (id) => {
            const widget = window.__KALXJS__.components.get(id);
            if (widget) {
                widget.updateState({ value: widget.state.value + 1 });
            }
        };

        // Signal framework ready
        window.dispatchEvent(new CustomEvent('kalxjs:init', {
            detail: { version: '2.2.8', framework: 'KALXJS' }
        }));

        // Export for testing
        window.__TEST_UTILS__ = {
            getDashboard: () => dashboard,
            getComponents: () => Array.from(window.__KALXJS__.components.values()),
            getComponentById: (id) => window.__KALXJS__.components.get(id)
        };
    </script>
</body>

</html>